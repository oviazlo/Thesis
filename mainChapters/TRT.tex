\chapter{Simulation and performance studies of the Transition Radiation Tracker with Argon-based gas mixture}
\label{chap:TRT}

% TODO write
% 1) explain my personal contribution to the study.

This chapter describe performance of the ATLAS Transition Radiation Tracker (TRT) detector in case of using 
Argon-based gas mixture in some parts of the detector.
TRT was built with focus on using Xenon mixture with carbon dioxide and oxygen additions (in proportion 70/27/3).
But apperance of leaks in some straw led to decision to switch to cheaper Argon-based mixture for leaking modules.
This chapter cover description of implementation of the Argon mixture in the TRT digitization package as well as possibility
to simulate detector with different gases in different parts.
Chapter consists from three section. In \SectionRef{sec:trt_straw_hw} general TRT description is present with emphasis
of description of the straw tube, used gas and front-end electronics.
Second chapter cover overview of the digitization package with detailed description of the Argon implementation in it.
Third part describe performance study of TRT on hit and track parameters with focus on active gas mixture. Comparison of 
Xenon- and Argon-based mixtures.

Argon and mixed Xenon and Argon detector configuration implementations, done by me, were integrated to the official TRT digitization 
package and are currently used for Monte Carlo simulation of the TRT. 
All Argon gas mixture properties needed for the implementation to the Digitization code were measured in the laboratory 
with straw prototype or by the Garfield package~\cite{garfield_program} by other TRT collaborants. 
Tracking performance study was done to understand behaviour of the Argon mixture in the TRT compared to the Xenon one.
Particle identification capabilities (by adsorbtion transition radiation photons) of the Argon gas mixture are not discussed 
in this chapter.

%#######################################################################################################################
% SECTION 0 ############################################################################################################
%#######################################################################################################################
\section{Introduction}
\label{sec:TRT_intro}

During Run-1 TRT detector was performing well, providing essential part of tracking information as well as particle identification
information by detecting transition radiation from electrons. But in the end of Run-1 a few leaks in the straws were
observed which caused large activity in order to understand and fix the problem. After detailed investigation it became
clear that it is impossible to change or fix part of problematic straws due to lack of access to them. That is why 
arrangments in the gas system was done in order to minimize leaks and study on possibility to use Argon-based 
gas mixtures (which are significantly cheaper) started. With time passing amount of leaking gas was increasing that is
why it become inevitably to switch to the Argon mixture some TRT modules. In \FigureRef{fig:mixed_condition_2015_2016} used gas 
configurations of the TRT in 2015 and 2016 years are shown which demonstrates that problem is slowly developing
further.

\begin{figure}
\centering
\begin{subfigure}{.5\textwidth}
  \centering
  \includegraphics[width=\linewidth]{TRT/Xe_Ar_map_2015.png}
  \label{fig:sub1}
\end{subfigure}%
\begin{subfigure}{.5\textwidth}
  \centering
  \includegraphics[width=\linewidth]{TRT/Xe_Ar_map_2016.png}
  \label{fig:sub2}
\end{subfigure}
\caption{TRT gas configuration used during 2015 (left) and 2016 (right) data taking years.}
\label{fig:mixed_condition_2015_2016}
\end{figure}

% TODO write: study motivation
% 1) explain situation with leaking of the Xenon
% 2) describe pictures of the mixed condition for 2015-2016 and say some words about worst case scenario.

%#######################################################################################################################
% SECTION 1 ############################################################################################################
%#######################################################################################################################
\section{Detector design and front-end electronics}
\label{sec:trt_straw_hw}

\subsection{Detector design}
\label{subsec:trt_description}

% TODO 
% 1) insert fancy picture of the TRT
% 2) some information about tracking here? change name of the subseciton then?
% 3) some information about transition radiation?
% 4) 

The ATLAS Transition Radiation Tracker is the outermost of the three tracking subsystems of the ATLAS Inner Detector. 
ATLAS is one of two general-purpose detectors built for the Large Hadron Collider at CERN.

The TRT contains $\sim$300000 thin-walled proportional-mode drift tubes providing on average 30 two-dimensional 
space points with $\sim$130 $\mu m$ resolution for charged particle tracks with |$\eta$| < 2 and $p_T$ > 0.5 GeV~\cite{Abat:2008zza,Abat:2008zzb,Abat:2008zz}.
Along with continuous tracking, the TRT provides electron identification capability through the detection of transition radiation X-ray photons.

% Implementation of Argon simulation
% Till now TRT simulation code supported only Xenon based gas-mixtures as active gas in the tubes. 
% Current study is focused on implementation of simulation of Argon based gas-mixture, 
% which was used for a few runs of data taking in 2013 in a few TRT modules.

% Performance study
% Performance study of the TRT using Argon and Xenon based gas-mixtures will be presented.
% Hit and track parameters, such as hit reconstruction efficiency, residuals, track momentum resolution and extension fraction
% will be shown for both gas-mixtures and compared to Monte Carlo simulation.

% Current note are dedicated to the performance study of Transition Radiation Tracker (TRT) of ATLAS detector on hit and track parameter with focus on active gas mixture.
% It consist from technical description of implementation of Argon-based active gas mixture to the TRT Digigtization package of ATHENA framework and performance study itself. 
% Aim of current study was to investigate scenario when instead of standart Xenon-based mixture Argon-based mixture will be used in some part of detector. Main parameters of interest
% were hit residuals, track extension fraction ???
% Motivation for current study was leakages in tubes ???



\begin{figure}
\centering
\includegraphics[width=.6\textwidth]{TRT/TRT_improvement_momentum_resolution.png}
\caption{ 
Momentum resolution determined from cosmic ray data, taken in 2008, as a function of transverse momentum~\cite{Aad:2010bx}.
The resolution are shown for simulated full ID tracks (stars), full ID tracks (solid triangles) and silicon-only tracks (open triangles).
}
\label{fig:gas_gain}
\end{figure}



\subsection{The straw tube and operating gas mixture}
% - main idea of signal detection 
% - material of the straw
% - gas mixture and all properties

The main basic elements of the TRT is proportional drift tubes, hereafter called straw tubes or simply straws.
Tubes need to have good electrical (the cathode resistance has to be as low as possible) and mechanical (to avoid gas leaks) properties.
Geometrical factor has to be taken into account as well. Large straws provide better hit efficiency; small straws provide small drift time (time to collect electrons in the tube).
Another crucial requirement was a limit on thickness of the tubes. 
In order to let low-energy transition radiation photons (created by electrons passing radiators) go through and be adsorbed in the gas, tube walls need to be as thin as possible.

All these requirements were considered during the design face and most optimal choise was used.
Tube size is 4 mm in diameter. Walls are made from two layers of multilayer film. Section of the straw wall is shown in \FigureRef{fig:straw_wall_section}.
Two layers consist from 6 $\mu$m thick carbon-polyimide layer, which protects 0.2 $\mu$m thick Al layer, which is coated on 25 $\mu$m Kapton film.
These two layers were placed back to back and were glued by 5 $\mu$m thick polyurethane layer.
Mechanically, tubes were supported by carbon fiber bundles, which were placed from four sizes around each tube.
The anode is 30 $\mu$m diameter tungsten wire coated with 0.6-0.7 $\mu$m layer of gold.

\begin{figure}
\centering
\includegraphics[width=.4\textwidth]{TRT/straw_cross_section.png}
\caption{ 
Section of the TRT straw tube wall.
}
\label{fig:straw_wall_section}
\end{figure}

Active detector volume of straw is gas mixture which is flushed through the tubes with help of the gas system.
% TODO make similar chapter about transiiton radiation, same as Alex
This mixture was carefully chosen in order to be safe to use, compatible with detector materials and to not have dissociation products (after electron avalanche) 
with aggressive properties.
Higher electron drift velocity is preferred as well as wide operating plateau (range of high voltage were straws works in the proportional regime). 
Latter is important in order to have 
safety margin in case high voltage has to be changed to correct for temperaature variations, to enhance signal to noise ratio or to adjust for 
heavy-ionizing particle effect~\cite{Abat:2008zza}.
Nobel gases were considered as a main component of gas mixture. Because they are inert they are safe to use in the detector for a long time and they have 
excellent photo-adsorbtion cross sections.
Target energy of transition radiation photons to be absorbed in order to make electron identification is in range 1-20 keV.
In \FigureRef{fig:absorption_lenght} absorption lenghts are shown for four most heavy noble gases.
As one can see the best choice would be the Radon gas, but due to its radioactivity it can not be used.
Next candidate was Xenon and it was choosen to be a main gas component.
Because of big cost of Xenon it was decided for all tests and during commisioning phase before pp collisions to use Argon gas. That is why read-out electronics were
designed with possibility to work with Argon- and Xenon-based gas mixtures, as described in \SectionRef{subsubsec:front_end_electronics}.

\begin{figure}
\centering
\includegraphics[width=.7\textwidth]{TRT/absorption_lenght_noble_gases.png}
\caption{ 
  Absorption lenght as a function of photon energy for heaviest noble gases. Data was taken from~\cite{Hubbell:353989}.
}
\label{fig:absorption_lenght}
\end{figure}

In order to have well controlled electron avalanches in the straw one need to add another gas component, a quencher, 
which will absorbs UV photons created in the avalanche process and prevent secondary avalanches which can lead to early breakdown.
After dedicated study, reported in~\cite{Abat:2008zza}, it was decided to use a carbon dioxide as a quencher due to suitable and well known properties.
In order to even more increase operating plateau a third gas component, oxygen, was added.
By itself $O_2$ does not interact with UV photons, but ozone ($O_3$), which is created in the electron avalanches, does.
However, $O_2$ is strongly electronegative gas which can negatively affect straw performance (by capturing primary electrons during the drift, as is described below)
that is why only few percents can be used in the mixture.
 
The final choice of the gas mixture to be used in the TRT was decided to be 70$\%$ of Xenon, 27 $\%$ of carbon dioxide and 3$\%$ of oxygen.
But when some straws start to leak it was decided to switch the main gas component from Xenon to Argon, due to economical reasons.
Argon has significatly higher absorption lenght with respect to Xenon, as can be seen in \FigureRef{fig:absorption_lenght} (around order of magnitute difference), 
that is why tubes with Argon almost completely loose the ability to detect transition radiation, 
which correspond to loosing the ability of particle identification.

Operating working gas gain for straws were chosen to be 2.5 $\cdot$ 10$^4$~\cite{ID_TDR_vol1}. It correspond to 1530 V for Xenon mixture as shown in \FigureRef{fig:gas_gain}.
Gas gain curve for the Argon mixture is significantly different and to reach thew same gain only 1420 V have to be applied.

\begin{figure}
\centering
\includegraphics[width=.5\textwidth]{TRT/gas_gain_Xe_Ar.png}
\caption{ 
Straw gas gain as a function of high voltage for different gas mixtures. Taken from~\cite{Abat:2008zza}.
}
\label{fig:gas_gain}
\end{figure}


% TODO toWrite descfribe gas gain in general. Say about Argon mixture. Explain plot \FigureRef{fig:gas_gain} in the text.

\subsection{Front-end electronics and signal processing}
\label{subsubsec:front_end_electronics}

% TODO toWrite 1) idea of the signal digitization. Explain plot \FigureRef{pulseDigitization}. Say that we want to measure drift time of the electrons!
% TODO toWrite 2) But we have ions as well. Explain plot \FigureRef{fig:ion_tail}
% TODO toWrite 3) Start explanation of the ASDBLR chip. Explain that it kill ion tail with shaping function. Explain triggering over the two thresholds: LT - for tracking; HT - electron PID.

The main purpose of the TRT is to provide hits for track reconstruction and information for electron identification by detecting transition radiation photons.
In order to get the best possible precision of hits one need not only have possibility to identify which straws particle went through 
but also to measure the closest approach of the track to the straw wire. For this purpose the drift time of electron clusters to the wire has to be measured.
That is why TRT front-end electronics were design to perform precise measurements of the timing information of the straw signal.
One want to measure time when signal arrives (drift time of the electron clusters to the anode wire) and duration of the signal, so-called Time over Threshold (ToT).
Time over Threshold is needed to distinguish signals from particles originated from different bunch crossings 
and can be used for particle identification (because it charachterize amount of the ionization in the straw gas).
Typical time needed for electrons to drift from straw wall to the anode wire in the Xenon-based gas mixture correspond to 40-45 ns, which dictates size of the readout window to be 
3 BCID or 75 ns. As shown in \FigureRef{fig:pulseDigitization} signal is sampled with 24 bits (3.125 ns each). Value 1 is assigned to a bit if signal is higher than predefined threshold, 
otherwise value 0 is assigned. The first transition in the bit pattern from 0 to 1 correspond to the leading edge of the signal. Following transition from 1 to 0 
correspond to the trailing edge of the signal. Their difference is equal to the time over threshold of the signal. 

\begin{figure}
\begin{center}
 \includegraphics[width=0.8\columnwidth]{TRT/fromPoster/TRTdigi4.pdf}
\caption{Illustration of the digitization of a TRT low threshold signal.}
\label{fig:pulseDigitization}
\end{center}
\end{figure}

% TODO cross check with Anders, Kostja and Alex if this is true!!!
% Measurements in the laboratory showed that signal from the straw consists from two components, as shown in \FigureRef{fig:ion_tail}: 
% a sharp peak, which correspond to the primary ionization electrons, created by passing particle, reaching the anode wire and the ion tail, which is caused by ion drift towards the cathode.
% When ions hit the wall of the straw there is a probability that it will free a few electrons from the wall which will start to drift towards the anode.
% This effect is partly compensated by the oxygen gas component, which provide recapturing of the electron by oxygen moleulus, as described in the following \SectionRef{subsec:recapture}.
% But some electrons will reach anode and will cause slowly falling component of the signal. To cancel out 

Typical signal from the straw consists from two components, as shown in \FigureRef{fig:ion_tail}: 
a sharp peak, which correspond to electron drift and slowly following ion tail, which correspond to ions of gas atoms created in the avalanches process.
Only electron peak contain information of iterest (primary electron drift time) that is why ion tail canceled out by adding of the mirror image impulse to the signal.

\begin{figure}
\centering
\includegraphics[width=.6\textwidth]{TRT/ion_tail.png}
\caption{ 
 Typical signal from the TRT straw. Sharp peak correspond to the fast collection of the electrons. 
 Following tail is caused by slow drift of ions in the gas.
 Source:~\cite{ID_TDR_vol2}.
}
\label{fig:ion_tail}
\end{figure}

The ion tail cancellation and signal digitization is done by custom-made ASDBLR (Amplification, Shaping, Discrimination and Base-Line Restoration) chip. 
This chip also perform restoration of the signals baseline and discrimination against the thresholds. 
Electronics make discrimination against two different threshold. One threshold, so-called Low Threshold (LT), 
is used to trigger on cases when high-energetic particle pass through the straw and ionize gas along it's path (and it is shown in \FigureRef{fig:pulseDigitization}).
Second one is used for transition radiation case.
In contrary to the high-energetic particles, transition radiation photons deposit all their energy practically in one point when interacting with gas.
It correspond to large number of primary electrons which is propagated to a large read-out signal.
That is why a second threshold, so-called High Threshold (HT), used to trigger on such cases, are significantly larger to the LT.
Values used for the Xenon-based gas mixture are correspond to 300 eV and 6 keV correspondly.
Discrimination against HT is done per BCID. 

In total ASDBLR chip provide 24+3 bits which correspond to 24 LT bits and 3 HT bits over 75 ns read-out window.
Summary schematic of work of ASDBLR chip is shown in \FigureRef{fig:nice_asdblr_schematics}.
ASDBLRs are placed close to the straw in order to reduce noise in the signal. One chip read-out eight straws.
Next component in the read-out chain is a complementary read-out chip DTMROC (Drift Time Measurements Read Out Chip), which accept 
information from two ASDBLRs, which hold data in the pipeline until the first level trigger arrives. If the event is accepted 
data are sent 
The overall TRT read-out chain is shown in \FigureRef{fig:electronics}. The detailed description of the TRT electronics is reported in~\cite{TRT_electronics}.

\begin{figure}
\centering
\includegraphics[width=.8\textwidth]{TRT/nice_ASDBLR_schematics.png}
\caption{ 
 ??? Source:~\cite{Aad:2008zzm}.
}
\label{fig:nice_asdblr_schematics}
\end{figure}


\begin{figure}
\centering
\includegraphics[width=.7\textwidth]{TRT/electronics.png}
\caption{ 
 Schematic representation of the TRT readout electronic.
}
\label{fig:electronics}
\end{figure}



\subsection{Tracking with the TRT}
% TODO explain here
% 1) shortly about ID tracking 
% 2) TRT improvement of momentum resolution
% 3) TRT hit and track parameters
% 4) definition of the time and hit residuals. Use the same picture as Alex has in his thesis.
% 5) definition of tube and precision hits!!

Track reconstruction algorithm require a list of spatial hits with errors in order to build a track.
In the s

In order to perform track reconstruction algorithms using TRT hits one have to provide 
Reconstruction algorithm take as input require position of the hits as well as their errors.
% TODO explain picture with drift circle.

The first task is to properly measure drift time of the electrons to the anode wire. Time of the leading edge of the signal from particle
consists from the two components: actual drift time of electrons ($t$) and calibration constant $T_{0}$ as illustrated in \FigureRef{fig:pulseDigitization}.
Calibration constant $T_{0}$ consists from three components:
\begin{itemize}
 \item Collision time with respect to the edge of the LHC clock. Lenght of bunches are typically are 1.1-1.2 ns and collisions are happening along the whole bunch.
 \item Time of flight particle to the straw. Straws are placed on distance from 0.5 to 2.6 meters from the interaction point 
 which correspond up to 9 ns of time needed for relativistic particle to reach farthest straws.
 \item Time of the signal propagation in the wire to the front-end electronics. Typically a few nanoseconds.
\end{itemize}
Calibration constant $T_{0}$ is obtained from calibration procedure which is done after each run.
Also during the calibration so-called $r-t$ relation is built and fitted 

% TODO explain r-t relation taken from the data during the calibration...
Next step is to convert drift time to the so-called drift radius which is drift distance of the the electron cluster to the anode wire.
To perform this operation one need to know $r-t$ relation

Detailed explanation of the calibration procedure can be found in:~\cite{alonso_thesis}.

\begin{figure}
\centering
\includegraphics[width=.7\textwidth]{TRT/drift_radius.png}
\caption{ 
 ???
}
\label{fig:electronics}
\end{figure}

%#######################################################################################################################
% SECTION 2 ############################################################################################################
%#######################################################################################################################
\section{Modelling of the new Argon-based gas mixture in the TRT}
\label{sec:digi_argon}

In this section description of the digitization code will be present with detailed explanation of the implementation of the Argon-based gas mixture.
Main task of the digitization code is to simulate number and properties of primary electron clusters as well as their drift in the gas to the anode wire.
Response of the front-end electronics which provide final digitized timing information is simulated as well.

\subsection{Monte Carlo simulation of the ATLAS detector}

In order to have possibility to reconstruct any physics process which happenned in high energetic particle collisions at collider or to measure some corresponded physics quantity of the process
one need to have a clear picture of the detector response from each detector sub-system. But beside of the understanding of the real detector performance it is equaly important to have 
simulation of the detector in which you can trust. Simulation of the detector responce allow to perform many sophisticated studies, such as study of the detector effects and systematics,
to distinquish background processes from specific process of interest or even to predict possibility to ``see'' a signal from some hypothetical model with given amount of data.
A lot of effort was spent to make and validate detector software. In ATLAS simulation of the detector responce is done in a few well defined steps, which are:
\begin{itemize}
 \item Event generation. In this step simulation of the physics process of interest is simulated itself. This is done by specialized Monte Carlo generators, which calculate matrix-elements of the
 hard process for a specific initial condition (beam parameters) and in the end produce distribution of the elementary particle with defined momenta and directions. Typical MC generators used in ATLAS
%  TODO references!!!
 are PYTHIA, HERWIG, SHERPA and other.
 \item Simulation. Particles created in the collisions fly through the detector and interact with detector material. These interactions are simulated, which define trajectories of the particles and
 energy depositions in all sub-detectors. 
 %  TODO references!!!
 It is done with GEANT4 package which return list of hits, so-called simulation hits, or simply simhits, which contain position and timing information of 
 the interaction together with amount of energy lost by the particle due it (deposited in the detector material).
 \item Digitization. Energy depositions in the detectors create an analog signals which are read and processed by the read-out electronics. In this step behaviour of the front-end electronics to this
 depositions is simulated together with a signal processing, done in the electronics, in order to simulate the same outpus (measured quantities) as real electronics provide (e.g. hit in the pixel or strip,
 digitized current from the PMT or calorimeter cell, etc.). Due to different read-out electronic designs for different sub-detectors digitization software is different for each sub-detector.
 And it is written and maintained by each detector community separately.
 \item Reconstruction. The final simulation step is to collect all information from sub-detector together, apply all needed calibration and aligment corrections and reconstruct physics objects 
 (by using special algortihms and following designed procedures). This step is practically identical to one with real data only that mentioned above corrections can be different for simulated and real 
 data (e.g. some timing shifts in the electronics could be not simulated because they don't play any role, but it will lead that timing corrections of calibrated constants will be different 
 for simulation and for real data).
\end{itemize}

\subsection{Simulation and digitization of the Argon gas mixture in the TRT}
\label{subsec:TRT:argonImpl}
% TODO should I write here information about energy depositoin calculated not with GEANT4 but with PAI modeil in the digitization package???

% - Describe all steps of MC production, as described in the Esben thesis.
% - for simulation part make reference to the Esben thesis, say that it is described there.
% - 

Geometry of the TRT is described in the ATLAS simulation package and on simulation step it is used simulation of particle interaction with detector material as was described previously.
But due to the fact that standart-configured GEANT4 package make poor job on calculating energy deposition in thin layer of gas in tubes 
(which is described in following \SectionRef{subsec:pai_model}) it was decided to take care of this simulation during the Digitization step in the Digitization package.
So from simulation step only list of hits in TRT are used when energy deposition to the gas inside the tubes are calculated in Digitization step.

The Digitization package also cover simulation of following properties:
\begin{itemize}
 \item Number of primary ionization clusters along the particle path and number of electrons in these clusters
 \item Drift time of the electrons to the anode wire with taking into acount magnetix flux density and drift diffusion
 \item Gas gain simulation and electron recapture probability by the oxygen moleculus % TODO is it realy the case? check the code!!!
 \item Signal shaping and discrimination by the front-end electronics
 \item Detector white noise
\end{itemize}

% TODO explain how Argon implementation was done.
All these parameters depends from the types and proportition of the components used in the gas mixture. 
In order to implement new Argon gas mixture to the Digitization package all these properties were considered in detail 
and proper imlementation of all of them were done.


% \subsection{Digitization of the mixed gas configuration}
% 
% % TODO revisit this piece of text
% 
% TRT detector was originally designed as an homogenous detector and it was planned that only one gas mixture will be used in the all straws. 
% Digitization code, as all physics codes, was written with an idea to be as simple as possible, that is why it was designed with assumption that all straws will be simulated with only one type of gas mixture.
% But after leakeges appears at the end of the Run 1, it become higly probable, that TRT may be run in mixed condition, when some part of straws will be run with one gas and other part - with another. That's why 
% possibility to digitize mixed condition become essential feature of the code. 
% 
% To make it work new (to the digitization code) Argon gas mixture was introduced and following simulated detector/electronics parameters as low/high treshold and shaping functions were duplicated.
% Digitization of the TRT hits are done straw by straw and in the beginning of the straw loop flag \mbox{ ``isArgonStraw''} is read from the COOL database. This flag represent is current straw contain Argon or Xenon based 
% gas mixture. The straw map lays under \mbox{/TRT/Cond/StatusHT} COOL folder, and one need to specify dedicated tag to make mixed Ar/Xe digitization.
% According to this flag relevant thresholds and shaping function are picked up and used during digitization following straw. 
% 
% 
% \begin{figure}
% 
% \begin{subfigure}{.5\textwidth}
%   \centering
%   \includegraphics[width=\textwidth]{TRT/mapXY_barA.pdf}
% \end{subfigure}%
% \begin{subfigure}{.5\textwidth}
%   \centering
%   \includegraphics[width=\textwidth]{TRT/mapXY_endA.pdf}
% \end{subfigure}
% 
% \caption{$T_{0}$ calibration constants obtained for MC simulation for Barrel A (left) and End-cap A (right) detectors for the mixed Xenon-Argon condition. 
% 	  Modules with Argon gas have different $T_{0}$ calibration constants.}
%   \label{fig:t0_mixed_condition}
% \end{figure}
% 
% 
% 
% Also two flags which provide simple possibility to change active gas mixture from default one (Xenon) to the optional (Argon) for all straws were implemented. These are:
% \begin{itemize}
%  \item UseArgonStraws
%  \item UseConditionsHTStatus
% \end{itemize}
% 
% First flag says that we want to use optional gas in some part or in full detector. If it is false - default Xenon gas will be used despite of the second flag. 
% Second flag says do we want to read straw map from COOL database or not.
% If it is false full Argon geometry condition will be run. Example of usage these flags can be found at [???].
% 
% Points related to the actual gas mixture implementation are described at the next subsections.


\subsection{Simulation of the deposited energy to the gas and initial number of electrons in a cluster}
\label{subsec:pai_model}
During the development phase of the TRT simulation and digitization software it was found out that GEANT4 simulation does not provide accurate enough description of the physics
of a charged particle passing through the very thin gas layers (straws). 
% Kittelman thesis, p.92, Figure 9.2.
In ~\cite{kittelmann_thesis} author made a comparison of photo absorption cross section parameterisation used in GEANT4 with more detailed one provided by I. Gavrilenko.
Even though difference between these two parameterisations were small, using them in the code led to 7$\%$ difference in the mean free path lenght, which is significant for the TRT straw simulation.
That is why a dedicated model so-called photo absorption ionisation (PAI) model~\cite{pai_model_paper} is used to simulate deposited energy to the gas in the straw.
This model derive ionisation cross section for charged particle of specific gamma factor numerically from the tabulated values of photo absorption cross section for the gas.
The missing piece for the Argon-based gas mixture simulation was lack of photo absorption cross section for Argon itself in the code.
Cross section reported in~\cite{argon_cross_section} was taken and was implemented in the code.

As described previously propagation of the charged particle through the ATLAS detector is done by GEANT4, which in practise correspond to the list of simulation hits in the detector.
These hits are used as a reference while real ionization clusters are calculated by the PAI tool in the region along the simhits.
PAI tool calculate mean free path, the distance between two neighboar electron clusters in the gas, and energy deposited to the cluster. 
Mean free path for Xenon- and Argon-based gas mixtures, calculated by PAI tool, are shown in \FigureRef{fig:meanFreePath} as a function of the scale kinetic energy 
(the kinetic energy of particle scaled by factor $\frac{m_{proton}}{m_{particle}}$). As on can see mean free path for Argon mixture is 1.5 time larger with respect to the Xenon mixture.
Mean free path for the high energetic pion is 150-160 $\mu$m in the Xenon mixture. If pion will penetrate straw centrally close to the anode (will travel 4 mm in the gas) 25-27 primary cluster will appear.
But if it will travel 2 mm in the gas number of cluster will be only 12-14, part of which will not reach anode due to recapture in the oxygen. 
That is why measurement of the time of the first cluster arrive to the anode will not directly correspond to the measurement of the distance of closest approach between the wire and track, 
which can be seen in \FigureRef{fig:clusterDriftInTube}. This effect is directly linked to the spatial resolution of the hit.
For the Argon mixture number of cluster will be even smaller (8-9 clusters created by particle traveling for 2 mm in the mixture), which led to worse spatial hit resolution in the Argon mixture comparing 
to the Xenon one.

\begin{figure}
\centering
 \includegraphics[width=0.7\columnwidth]{TRT/meanFreePath.eps}
\caption{???}
\label{fig:meanFreePath}
\end{figure}

When charged particle go through active gas volume of the straw it interacts with gas molecules.
It can either ionize them by kicking out an electon or it can excite them. Energy needed to kick out least bound shell electron for TRT gases lays
in range of 10-20 eV. But part of the energy goes to the excitation of gas moleculus that is why the average energy needed to create an ion pair (so-called W-value) is higher than energy needed to 
kick out an electron. List of these values for all gases used in TRT are shown in \TableRef{tab:ionization_energy}.
Using values from the table and knowing gas mixture proportions (70/27/3 $\%$) one can estimate the average energy for Xenon-based mixture, which is equal 25.3 eV.

In the same way W-value for Argon-based mixture was calculated, which was equal to 28.3 eV and it was implemented in the digitization code.
Number of primary electrons, $N_{prim.electrons}$, is calculated by the formula:
\begin{equation}
 N_{prim.electrons} = floor \left[\dfrac{E_{deposited}}{W} + 1\right]
\end{equation}
where $E_{deposited}$ is energy deposited to the gas, W is average ionization energy described above and $floor$ function is a function which return
largest integer which does not exceed the argument of function.
From this formula one can say that number of primary electrons in clusters in Argon-based mixture are smaller than for Xenon-based one 
(assuming the same amount of deposited energy).

\begin{table}[p]
  \begin{tabular}{c|c}
    Gas & W [eV / ion pair]\\
    \hline
    Xe & 22.1 $\pm$ 0.1 \\
    Ar & 26.4 $\pm$ 0.5 \\
    CO$_2$ & 33.0 $\pm$ 0.7 \\
    CF$_4$ & 29.2 $\pm$ 1.0 \\
    O$_2$ & 30.8 $\pm$ 0.4 \\
  \end{tabular}
  \caption{The average energy needed to create an ion pair for electrons and photons (W-value) for different gases, 
  considered to be used in the TRT as is reported in~\cite{cwetanski_thesis}.}
  \label{tab:ionization_energy}
\end{table}

\subsection{Electron drift velocity and $r-t$ relation}
% TODO here...

Very crucial part of the digitization is to model drift time of primary electrons, which appeared after interaction of the paticle with gas, to the anode wire.
Because drift time directly corelate with drift radius, which is position of the hit with respect to the straw wire.
During the drift of the electron in the tube it hits gas moleculus but continue it's path to the wire due to presence of electrical field.
In \FigureRef{fig:clusterDriftInTube} (left) example of the drift trajectories of electrons in the tube without magnetic field are shown.
Because of the presence of the many created electrons in one straw it will be too heavy computation to proper simulate electron drift of all electrons in all
tubes in the detector. Moreover, beside drift in the gas one have to simulate creation of the avalanches with proper simulation of the all secondary effects
as creation of the UV photons and other. But if one will keep all tubes in the same condition (constant gas gain) during the detector operation it would
be possible to use average values of the drift time precisely measured by the Garfield package (and cross checked in the labratory with the straw) to simulate it.
And that is the approach used by the TRT community. 

\begin{figure}
\begin{center}
 \includegraphics[width=0.85\columnwidth]{TRT/electron_drift.png}
\caption {Electron drift in a straw tube without (left) and with (right) magnetic field. Source: ~\cite{cwetanski_thesis}. 
}
\end{center}
\label{fig:clusterDriftInTube}
\end{figure}

In \FigureRef{fig:rt_comp} (left) drift distance as fuction of the drift radius measured with the Garfield package for case without magnetic field is shown.
It was obtained by making a scan of drift distances (in range from 0 to 2 mm) and simulating the drift time which it take first electron to reach the anode wire.
Shown relation is called $r-t$ relation and is used in the code to translate drift distance to the drift time.
In \FigureRef{fig:clusterDriftInTube} (right) drift trajectories of the cluster in the presence of the magnetic field is shown. One can see that magnetic field
significantly affect electron drift trajectories and make drift time longer due to Lorentz force. $r-t$ relation for case with 2T magnetic field is shown
in \FigureRef{fig:rt_comp} (right) and it clearly seen that drift time is higher in this case. But magnetic field is not homogenous within the detector.
This effect was studied before (for example in~\cite{esben_thesis}) and it was found out that drift time dependency from magnetic field can be 
described by a second order polynomial. 
To get $r-t$ relation for some specific value of magnetic field, $B_{eff}$, following interpolation formula is used:
% TODO cross check this formula in the code!
\begin{displaymath}
    RT(B_{eff}) = (RT_{MAX} - RT_{WO}) \cdot \dfrac{B_{eff}^2}{B_{max}^2} + RT_{WO}
\end{displaymath}
where $RT_{MAX}$ correspond to the $r-t$ relation for magnetic field $B_{max}$ (which is equal 2T - a maximum magnetic field in the ATLAS) and $RT_{WO}$ is 
$r-t$ relation for case without magnetic field.

\begin{figure}
\centering
 \includegraphics[width=0.99\columnwidth]{TRT/rt_comp.png}
\caption{r-t relation for the Xenon- (red) and Argon-based (green) gas mixtures. Curve for the Argon-based mixture was obtained from the Garfield simulation and
was provided by K.Vorobev. Also scaled (by ratio of the average drift velocities in the Argon and Xenon mixtures) 
r-t relation of the Xenon-based mixture is shown in gray which was used in the initial studies of the Argon mixture.
}
\label{fig:rt_comp}
\end{figure}

For the Argon gas mixture two such $r-t$ relation tables were added to the TRT digitization package.
In the early development stage a Xenon gas $r-t$ relations scaled by ratio of the average drift velocities in the Argon and Xenon were used in the code 
(gray points in the \FigureRef{fig:rt_comp}), which demonstrate difference of the shape of distributions for Argon and Xenon gases.

% Drift diffusion in the code:
% https://svnweb.cern.ch/trac/atlasoff/browser/InnerDetector/InDetSimUtils/TRT_DriftTimeSimUtils/tags/TRT_DriftTimeSimUtils-00-00-27/src/TRT_BarrelDriftTimeData.cxx?order=date&desc=1

Movement of the electron in the gas contains stochastic component due to collisions with gas atoms. 
That means that drift time can differs for clusters which drift from the same distance.
The spread of the drift time for as a function of the drift distance is shown in \FigureRef{fig:diffusion}.
Black points correspond to drift time spread obtained from Garfield simulation for the Argon gas mixture.
In the digitization code spread distribution is parametrized by the 4-th order polinominal, which was used for Argon as well
in order to preserve consistency (shown with red and green points in \FigureRef{fig:diffusion} for Xenon and Argon accordingly).

\begin{figure}
\begin{center}
\includegraphics[width=0.69\columnwidth]{TRT/diffusion.eps}
\caption{???}
\label{fig:diffusion}
\end{center}
\end{figure}


% \subsection{Electron recapture}
\subsection{Electron attachment processes in oxygen}
\label{subsec:recapture}
When electrons drift towards the anode there is a probablity that they will be captured by the oxygen moleculus in reactions
$O_2 + e^- \to O_2^-$ or $O_2 + e^- \to O + O^-$. Presence of the magnetic fiels enhance cross section of these reactions.
In order to take into account this effect a special study was done as is reported in~\cite{esben_thesis}.
It was found out that electron capture probability strongly depends from the distance between primary electron to the anode.
Garfield simulation shown that this dependence can be parametrized with forth order polinominal (see \FigureRef{fig:electron_recapture}), 
which was inplemented in the TRT digitization package. 
Because Argon-based mixture contain the same amount of the oxygen in it the same survival probability
curve was used for it as well. But separate implementation for the Argon was done in the code in order to allow future tuning of this effect separately for Xenon and Argon gas mixtures
in case of other concentrations of oxygen will be used.
% TODO ask Kostja: 1) did he look on it for Argon? 2) is it correct that Argon-mixture will have the same suvivl probability as in Xenon?

As it was described previously oxygen was added in the mixture in order to increase operating plateau of the straw, but there is an another effect which it take care of.
Drifting ions might free electrons when they reach cathode, which can in their turn make electron avalanches, which is not wanted effect.
As can seen from \FigureRef{fig:electron_recapture}, oxygen addition to the gas mixture provide 60$\%$ probability that these electrons will be recaptured 
and will never reach anode. 

\begin{figure}
\centering
\includegraphics[width=.7\textwidth]{TRT/electron_recapture.png}
\caption{ 
 Survival probability of the primary electron to reach the anode. Source:~\cite{esben_thesis}.
}
\label{fig:electron_recapture}
\end{figure}

\subsection{Signal shaping and discrimination}

% TODO ask Kostja why Argon shaping function has slower tail than Xenon one?
% TODO ask the same Andrew
% TODO what is about HT function?

As was previously described to cancel long ion tail part of the straw signal convolution with a special signal function is made by the TRT front-end electronics.
One need to simulate it as well in order to simulate proper response from the electronics. 
And this is another missing piece which was implemented for Argon mixture. 
Drift velocity in the Argon mixture is significantly larger than for Xenon a straw signal will differ significantly as well.
Argon gas was not planned to be used for physics data taking but it was used for many tests and comissioning phase for a smiple reason that it is significatnly
cheper than Xenon mixure. That is why support of the Argon mixture was foreseen for the ASDBLR chip. It contain set four shaping functions (which can be switched
by a pin on the board itself): two for Xenon and two for Argon mixtures. Two set for each gas are needed because different shaping functions are used for discrimination
on LT and HT. Shaping function for Argon gas, measured in the lab using prototype of ASDBLR chip, is shown in \FigureRef{fig:shaping} together with Xenon functions.
In the digitization package the same shaping functions are used. They are convoluted with an energy deposits, which are stored in a vector of time bins.

\begin{figure}
\begin{center}
 \includegraphics[width=0.69\columnwidth]{TRT/shaping.eps}
\caption{Argon low threshold shaping function in comparison with Xenon low and high treshold shaping functions}
\label{fig:shaping}
\end{center}
\end{figure}

% TODO here...
% TODO describe here about difference of the LT. Explain why we need different LT (hit efficiency?).
% TODO Why so big difference for Xenon and Argon?

After convolution signal is discriminated againt LT and HT and 24+3 bit pattern is formed.
Obviously tubes with Xenon and Argon mixture should have different threshold settings.
As was previously described Argon gas mixture has significatnly smaller signal, because
number of primary electron clusters are smaller and number of electrons in this clusters are smaller as well.
When some parts of detector works with Argon and other with Xenon their performance must be kept on the same level for
proper operation. Practically that mean that hit efficiency (probability that there will be a hit if particle went through the straw) have to be 
similar. To get it low threshold for Argon have to be significantly smaller to reach the same efficiency as Xenon straws.
Also threshold can have different values for barrel and endcap part. This caused because endcap straws positioned perpendicular to the barrel straws, 
which change behaviour of the drifting electrons in the tubes due to different orientation of the magnetic field.
Possibility to set separate thresholds for Argon tubes were implemented in the code.
After preliminary studies in the laboratory it was found out that low threshold for Argon have to be around 100 eV 
(while for Xenon straws this value is 285 eV for Barrel and 300 eV for end-cap detectors), which was used in the code.
Low threshold values are main parameter of interest for Monte Carlo simulation tuning. That is why tune studies are always ongoing 
in the TRT community but it is not covered in the current chapter.

\subsection{White noise modelling}

% TODO I am not sure if it is this note.... and it's internal note???
Noise note:~\cite{Kittelmann:987854}

% TODO describe using Esbens's thesis.

[TODO] see comments in TRTDigCondFakeMap::setStrawStateInfo() function.


\begin{equation}
 LT_i = A_i \cdot (\alpha + \beta \cdot ErfcInv(\gamma \cdot f_i)) %TODO make EffcInv as in Noise note (eq. 2)
\end{equation}

%%% OR 
%%% 
%%% just say that according to the Noise revision note LT_i is proportional to the noise signal amplitude
%%%

% LTi = Ai · ( +  · ErfcInv(  · fi)) ,

%%% formula from ``Revision of Noise and Threshold Description in MC Simulation'':
%%% --> averagenoiseampforstrawlength = ( ( (3000.-1350.)/(70*CLHEP::cm) ) * strawlength + 1350.0 ) / 3000.0;
%%% according to Anatoli, we need to scale noise amplitude for Argon straws by factor LT_argon/LT_xenon
%%% --> scaleAmplitudeFactor = m_settings->lowThreshold(true)/m_settings->lowThreshold(false);
%%% --> averagenoiseampforstrawlength *= scaleAmplitudeFactor; 
%%% Found in file: ./InDetDigitization/TRT_Digitization/src/TRTDigCondFakeMap.cxx *

%%% WARNING Sasha: this function used hardcoded noise signal shape in TRTSignalShape.cxx line 58.
%%% WARNING Sasha: should noise be different for Argon? should I change something here?  
%%% WARNING Sasha: for now I will assume that it is okay for Argon
%%% Found in file: ./InDetDigitization/TRT_Digitization/src/TRTNoise.cxx *

\begin{figure}
\begin{center}
 \includegraphics[width=0.79\columnwidth]{TRT/grBMPos_mod.pdf}
\caption{ Position residual width as a function of the TRT module number in the Barrel detector. Red points correspond to simulation of TRT detector
using Argon-based mixture in all straws, black points correspond to Xenon-based mixture while green point correspond to the mixed detector condition
which was used during ??? data taking period. Modules with Argon mixture in mixed condition can be clearly seen.}
\label{fig:meanFreePath}
\end{center}
\end{figure}




%#######################################################################################################################
% SECTION 3 ############################################################################################################
%#######################################################################################################################
\section{TRT tracking performance with focus on active gas mixture}
\label{sec:digi_argon}

In the end of the Run-1 part of the TRT was operating with Argon mixture as shown in \FigureRef{fig:argonModulesIn2013}.
It was a good opportunity to test implementation of the Argon mixture in the digitization package.
This section contain overview of the track and hit performance of the TRT in this gas configuration.

\begin{figure}
\begin{center}
 \includegraphics[width=0.59\columnwidth]{TRT/fromPoster/ArgonModules2013.png}
\caption{Detector modules which were operated with Argon gas mixture during 2013 runs}
\label{fig:argonModulesIn2013}
\end{center}
\end{figure}

\subsection{TRT hit and track properties}

To charachterize performance of the ???

% TODO should I include some other parameters?
\begin{itemize}
 \item Reconstruction hit efficiency. This parameter charachterize probability that particle, which went through the straw, will lead to a hit.
 It is heavely depends from distance of the closest approach of particle to the anode wire, because larger gas layer particle will fly through more gas atoms it will
 ionize, larger the signal will be. That is why typically it is plotted as a function of track to wire distance. It is defined as:
 \begin{equation}
  \varepsilon = \dfrac{N^{TRT}_{hits}}{N^{TRT}_{hits} + N^{TRT}_{holes}}
 \end{equation}
 where $N^{TRT}_{hits}$ is number of TRT hits in track and $N^{TRT}_{holes}$ is number of holes in the track. Hole correspond to case when there is no hit in the straw
 but reconstructed track pass it.
 \item Position residuals. As described previously the width of this distribution charachterize detector resolution.
 \item Number of precision and number of all hits per track. Directly correlate with the track momentum resolution.
 \item Track extension fraction. Probability to find an extension of the track reconstructed in the silicon detector in the TRT.
\end{itemize}




\subsection{Time and spatial resolution}
\label{subsec:TRT:trackPerf}

% TODO add:
% 1) RT relation for Argon and Xenon with data!!! (I should have them!).

\begin{figure}

\begin{subfigure}{.5\textwidth}
  \centering
  \includegraphics[width=\textwidth]{TRT/fromPoster/rt_FinalXenon.eps}
\end{subfigure}%
\begin{subfigure}{.5\textwidth}
  \centering
  \includegraphics[width=\textwidth]{TRT/fromPoster/rt_FinalArgon.eps}
\end{subfigure}

\caption{Track to wire distance in Xenon (left) and Argon (right) straws in Endcap detectors.}
  \label{fig:RT_xenon_argon}
\end{figure}

During 2013 year a few runs with Argon gas mixture in the detetector was done in order to investigate performace of the detector with Argon as active gav.
Four of 32 phi sectors in the inner layer for the barrels and one of 14 wheel in the endcap A were filled with Argon mixture while other sectors were operating 
with usual Xenon mixture (as it shown in \FigureRef{fig:argonModulesIn2013}). Used Argon mixture had following cofiguration: Ar/CO$_{2}$/O$_{2}$ (70$\%$/27$\%$/3$\%$). In order to operate it high voltage had
to be higher [??? explain why HV has to be different] and it was 1470 V.




\begin{figure}

\begin{subfigure}{.5\textwidth}
  \centering
  \includegraphics[width=\textwidth]{TRT/fromPoster/resFitXenon.eps}
  \includegraphics[width=\textwidth]{TRT/resFitXenonEndcap.pdf}
\end{subfigure}%
\begin{subfigure}{.5\textwidth}
  \centering
  \includegraphics[width=\textwidth]{TRT/fromPoster/resFitArgon.eps}
  \includegraphics[width=\textwidth]{TRT/resFitArgon_Endcap.pdf}
\end{subfigure}

% \includegraphics[width=0.75\textheight]{monoW/kinematics_simplifiedSChannel_EFT_Wprime.png}
\caption{Position residuals. Barrel A.}
  \label{fig:resFit}
\end{figure}





\begin{figure}

\begin{subfigure}{.5\textwidth}
  \centering
  \includegraphics[width=\textwidth]{TRT/fromPoster/hit_eff_rtrack_bar_xenon_region.eps}
\end{subfigure}%
\begin{subfigure}{.5\textwidth}
  \centering
  \includegraphics[width=\textwidth]{TRT/fromPoster/hit_eff_rtrack_bar_argon_region.eps}
\end{subfigure}

% \includegraphics[width=0.75\textheight]{monoW/kinematics_simplifiedSChannel_EFT_Wprime.png}
\caption{Hit reconstruction straw efficiency as a function of track to wire distance.}
  \label{fig:hit_eff_rtrack_bar}
\end{figure}

As was mentioned above electrons drift faster in the Argon-based gas mixture than Xenon one, which can be observed in the track to wire distance
distributions shown in \FigureRef{fig:RT_xenon_argon}. 
This results that timing calibration constants have to be significantly different 
for Argon and Xenon straws which can be seen in \FigureRef{fig:t0_mixed_condition}. 


\begin{figure}
\begin{center}
 \includegraphics[width=0.9\columnwidth]{TRT/fromPoster/track_ext_frac_eta.eps}
\caption{Track extension fraction as a function of $\eta$ for Xenon and Argon active gas mixture obtained with MC simulation.}
\label{fig:meanFreePath}
\end{center}
\end{figure}



Due to a lower threshold a larger hit reconstruction efficiency is seen for Argon straws. This leads to a
larger number of hits per track and larger fraction of precision hits. Also position residuals are seen to be 
slightly larger. All these observations indicate that additional threshold tuning is required.

[TODO] think which plots can be added to this section.

\begin{figure}

\begin{subfigure}{.5\textwidth}
  \centering
  \includegraphics[width=\textwidth]{TRT/fromPoster/xenon_nHitsPerTrack_vs_phi.eps}
\end{subfigure}%
\begin{subfigure}{.5\textwidth}
  \centering
  \includegraphics[width=\textwidth]{TRT/fromPoster/argon_nHitsPerTrack_vs_phi.eps}
\end{subfigure}

\caption{Number of hits per track. MC simulation.}
  \label{fig:nPrecHitsPerTrack}
\end{figure}


\begin{figure}

\begin{subfigure}{.5\textwidth}
  \centering
  \includegraphics[width=\textwidth]{TRT/fromPoster/xenon_precHitFracPerTrack_vs_phi.eps}
\end{subfigure}%
\begin{subfigure}{.5\textwidth}
  \centering
  \includegraphics[width=\textwidth]{TRT/fromPoster/argon_precHitFracPerTrack_vs_phi.eps}
\end{subfigure}

\caption{Precision hit fraction. MC simulation.}
  \label{fig:precHitFracPerTrack}
\end{figure}

\subsection{Hit efficiency and track extension fraction}

\subsection{Momentum resolution}



